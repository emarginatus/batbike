---
output: 
  html_document:
    css: css/kaart.css
---


```{r load_packages, include = FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
library(htmlwidgets)
setWidgetIdSeed(1)
library(leaflet)
library(tibble)
library(rgdal)
library(readr)
library(dplyr)
library(tidyr)
```

```{r map_data, results='hide'}
route_segment <- readOGR("route/route.geojson", "OGRGeoJSON", verbose = FALSE)
knooppunt <- readOGR("route/knooppunt.geojson", "OGRGeoJSON", verbose = FALSE)
basis <- read_csv("route/route.csv") %>%
  group_by(route) %>%
  mutate(
    vorige = lag(knoop),
    segment = sprintf("%i-%i", pmin(knoop, vorige), pmax(knoop, vorige)),
    omkeren = vorige > knoop,
    id = row_number()
  ) %>%
  filter(!is.na(vorige)) %>%
  select(route, id, segment, omkeren) %>%
  rowwise() %>%
  mutate(
    segment = route_segment[route_segment$segment == segment, ] %>%
      coordinates() %>%
      "[["(1) %>%
      as.data.frame() %>%
      list()
  ) %>%
  unnest(segment, .drop = FALSE) %>%
  group_by(route, id) %>%
  mutate(
    volgorde = ifelse(omkeren, -1, 1) * row_number()
  ) %>%
  arrange(route, id, volgorde) %>%
  group_by(route) %>%
  do(
    lijn = select(., x = X1, y = X2) %>%
      as.data.frame() %>%
      Line() %>%
      list()
  ) %>%
  rowwise() %>%
  mutate(
    lijn = Lines(lijn, route) %>% 
      list() %>%
      SpatialLines(CRS("+proj=longlat +ellps=WGS84")) %>%
      list()
  )
```

```{r detailkaart, out.width="100%", out.height="900px"}
leaflet() %>%
  addProviderTiles("Thunderforest.OpenCycleMap") %>%
  addPolylines(
    data = basis$lijn[basis$route == "Wegwijzers"][[1]],
    color = "red",
    group = "Maximaal bewegwijzerd"
  ) %>%
  addPolylines(
    data = basis$lijn[basis$route == "Aanbevolen"][[1]],
    color = "blue",
    group = "Aanbevolen"
  ) %>%
  addAwesomeMarkers(
    data = knooppunt, 
    label = ~as.character(id),
    group = "Knooppunt",
    clusterOptions = markerClusterOptions()
  ) %>%
  addScaleBar(options = scaleBarOptions(maxWidth = 100, imperial = FALSE)) %>%
  addLayersControl(
    overlayGroups = c("Maximaal bewegwijzerd", "Aanbevolen", "Knooppunt"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup(c("Maximaal bewegwijzerd", "Knooppunt"))
```
